import librosa
import numpy as np
import os

def analyze_cry_logic(filename):
    print(f"--- æ­£åœ¨è®€å–ä¸¦åˆ†æéŸ³è¨Š: {filename} ---")
    print("é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜ï¼Œè«‹ç¨å€™...")
    
    # 1. è®€å–éŸ³è¨Š
    try:
        # è¼‰å…¥éŸ³è¨Šæª”
        y, sr = librosa.load(filename)
    except Exception as e:
        print(f"è®€å–å¤±æ•—: {e}")
        print("è«‹ç¢ºèªè©²æª”æ¡ˆæ˜¯å¦ç‚ºæ¨™æº–çš„ .wav æ ¼å¼ã€‚")
        return None, None

    # 2. æå–è²å­¸ç‰¹å¾µ (æ©Ÿå™¨è½åˆ°çš„å®¢è§€æ•¸æ“š)
    
    # ç‰¹å¾µ A: éŸ¿åº¦ (RMS)
    rms = librosa.feature.rms(y=y)
    avg_volume = np.mean(rms)
    
    # ç‰¹å¾µ B: éŸ³é«˜/é »è­œä¸­å¿ƒ (Spectral Centroid)
    centroids = librosa.feature.spectral_centroid(y=y, sr=sr)
    avg_pitch_feature = np.mean(centroids)
    
    # ç‰¹å¾µ C: å“­è²å¯†åº¦ (Onsets & Tempo)
    onset_env = librosa.onset.onset_strength(y=y, sr=sr)
    try:
        tempo = librosa.feature.tempo(onset_envelope=onset_env, sr=sr)
        bpm = tempo[0]
    except:
        bpm = 0 # è‹¥éŸ³è¨Šå¤ªçŸ­æ¸¬ä¸å‡ºç¯€å¥ï¼Œé è¨­ç‚º0

    print(f"--------------------------------------------------")
    print(f"[å®¢è§€æ•¸æ“šåˆ†æçµæœ]")
    print(f"1. éŸ³é‡å¼·åº¦ (RMS): {avg_volume:.4f} (æ•¸å€¼è¶Šé«˜è¶Šåƒå¤§å“­)")
    print(f"2. é »ç‡å°–éŠ³åº¦ (Hz): {avg_pitch_feature:.0f} (æ•¸å€¼è¶Šé«˜è¶Šå°–éŠ³)")
    print(f"3. å“­æ³£ç¯€å¥ (BPM): {bpm:.0f} (æ•¸å€¼è¶Šé«˜è¶Šæ€¥ä¿ƒ)")
    print(f"--------------------------------------------------")

    # 3. åˆæ­¥è²å­¸åˆ†é¡è¦å‰‡ (é–¾å€¼è¨­å®š)
    # é€™è£¡çš„æ•¸å€¼æ˜¯åŸºæ–¼ä¸€èˆ¬å¬°å…’æ•¸æ“šè¨­å®šï¼Œæœªä¾†å¯é‡å°æ‚¨çš„å¯¶å¯¶å¾®èª¿
    
    predicted_type = "æœªçŸ¥"
    urgency_level = "ä½"

    # é‚è¼¯åˆ¤æ–·æ¨¹
    if avg_volume > 0.08 and avg_pitch_feature > 2800:
        predicted_type = "ç–¼ç—› (Pain)"
        urgency_level = "é«˜ (ç·Šæ€¥)"
        print(">> åˆæ­¥åˆ¤å®šï¼šåµæ¸¬åˆ°é«˜èƒ½é‡èˆ‡é«˜é »å°–å«ï¼Œç–‘ä¼¼ç–¼ç—›æˆ–é©šåš‡ã€‚")
        
    elif bpm > 110 and avg_volume > 0.04:
        predicted_type = "é£¢é¤“ (Hunger)"
        urgency_level = "ä¸­"
        print(">> åˆæ­¥åˆ¤å®šï¼šåµæ¸¬åˆ°è¦å¾‹ä¸”æ€¥ä¿ƒçš„ç¯€å¥ï¼Œç–‘ä¼¼é£¢é¤“ã€‚")
        
    elif avg_volume < 0.03:
        predicted_type = "ç–²å€¦/å•œæ³£ (Tired/Whimpering)"
        urgency_level = "ä½"
        print(">> åˆæ­¥åˆ¤å®šï¼šèƒ½é‡è¼ƒä½ï¼Œè²éŸ³æ‹–é•·ï¼Œç–‘ä¼¼ç–²å€¦æˆ–æ’’å¬Œã€‚")
        
    else:
        predicted_type = "ä¸é©/å°‹æ±‚é—œæ³¨ (Discomfort/Attention)"
        urgency_level = "ä¸­"
        print(">> åˆæ­¥åˆ¤å®šï¼šæ•¸å€¼ä»‹æ–¼ä¸­é–“ï¼Œç–‘ä¼¼å°¿å¸ƒæ¿•ã€éç†±æˆ–å–®ç´”ç„¡èŠã€‚")

    return predicted_type, urgency_level

def get_context_and_decide(predicted_type):
    print("\n========================================")
    print("ç‚ºäº†æä¾›ç²¾æº–å»ºè­°ï¼Œè«‹è¼¸å…¥ç•¶ä¸‹æƒ…å¢ƒè³‡è¨Šï¼š")
    print("========================================")
    
    try:
        feed_input = input("1. è·é›¢ä¸Šä¸€é¤å·²ç¶“éäº†å¹¾å°æ™‚ï¼Ÿ (è«‹è¼¸å…¥æ•¸å­—ï¼Œå¦‚ 2.5): ")
        last_feed = float(feed_input)
        
        diaper_input = input("2. å‰›å‰›æª¢æŸ¥éå°¿å¸ƒäº†å—ï¼Ÿ (è«‹è¼¸å…¥ y æˆ– n): ")
        is_diaper_clean = diaper_input.lower()
    except ValueError:
        print("è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼Œç³»çµ±å°‡ä»¥é è¨­å€¼(2å°æ™‚/å·²æª¢æŸ¥)é€²è¡Œé‹ç®—...")
        last_feed = 2.0
        is_diaper_clean = "y"

    print("\n\n########################################")
    print("### æ™ºæ…§è‚²å…’æ±ºç­–å»ºè­° (SOP) ###")
    print("########################################")
    
    final_advice = ""

    # 4. ç¶œåˆé‚è¼¯åˆ¤æ–·
    if predicted_type == "ç–¼ç—› (Pain)":
        final_advice = "ğŸ”´ ã€ç·Šæ€¥æª¢æŸ¥ã€‘\nå“­è²é¡¯ç¤ºé«˜åº¦å£“åŠ›ã€‚è«‹ä¾åºæª¢æŸ¥ï¼š\n1. æ˜¯å¦æœ‰ç™¼ç‡’ï¼Ÿ\n2. æ‰‹è…³æŒ‡é ­æ˜¯å¦è¢«é ­é«®çºç¹ï¼Ÿ\n3. è…¹éƒ¨æ˜¯å¦è„¹æ°£ï¼ˆè…¸çµç—›ï¼‰ï¼Ÿ\nè‹¥å®‰æ’«ç„¡æ•ˆå»ºè­°è«®è©¢é†«ç”Ÿã€‚"
    
    elif predicted_type == "é£¢é¤“ (Hunger)":
        if last_feed < 1.5:
            final_advice = "ğŸŸ¡ ã€å®‰æ’«å„ªå…ˆã€‘\nè²éŸ³åƒé£¢é¤“ï¼Œä½†æ‰å‰›åƒé£½ä¸ä¹…ã€‚\nå»ºè­°ï¼šå¯èƒ½æ˜¯ã€Œå£æ…¾æœŸã€è¨å®‰æ’«ï¼Œè©¦è©¦çœ‹çµ¦å¥¶å˜´ï¼Œæˆ–æª¢æŸ¥æ˜¯å¦éœ€è¦æ‹å—ã€‚"
        elif last_feed > 3.0:
            final_advice = "ğŸŸ¢ ã€ç«‹å³é¤µé£Ÿã€‘\nè²éŸ³èˆ‡æ™‚é–“çš†ç¬¦åˆã€Œé£¢é¤“ã€ç‰¹å¾µã€‚\nå»ºè­°ï¼šé€™æ˜¯ä¸€æ¬¡æ¨™æº–çš„é¤µé£Ÿè¨Šè™Ÿï¼Œè«‹æº–å‚™é¤µå¥¶ã€‚"
        else:
            final_advice = "ğŸŸ¢ ã€å˜—è©¦é¤µé£Ÿã€‘\nå¯èƒ½æ˜¯çŒ›é•·æœŸææ—©é¤“äº†ï¼Œå»ºè­°å¯ä»¥é¤µé¤µçœ‹ã€‚"
            
    elif predicted_type == "ç–²å€¦/å•œæ³£ (Tired/Whimpering)":
        final_advice = "ğŸ”µ ã€ç¡çœ å„€å¼ã€‘\nå¯¶å¯¶ç´¯äº†ï¼Œéåº¦åˆºæ¿€æœƒè®“ä»–å´©æ½°ã€‚\nå»ºè­°ï¼šæŠŠç‡ˆèª¿æš—ï¼Œæ’­æ”¾ç™½å™ªéŸ³ï¼Œæ¸›å°‘äº’å‹•ï¼Œå˜—è©¦å“„ç¡ã€‚"
        
    else: # ä¸é©/å°‹æ±‚é—œæ³¨
        if is_diaper_clean == "n":
            final_advice = "ğŸŸ¡ ã€è­·ç†æª¢æŸ¥ã€‘\nè«‹å…ˆæ›´æ›å°¿å¸ƒã€‚\nè‹¥å“­è²æŒçºŒï¼Œæª¢æŸ¥å®¤æº«æ˜¯å¦å¤ªç†±ï¼ˆæ‘¸å¾Œé ¸ï¼‰æˆ–è¡£ç‰©æ¨™ç±¤æ˜¯å¦åˆºç—›ã€‚"
        else:
            final_advice = "ğŸŸ¡ ã€äº’å‹•éœ€æ±‚ã€‘\nç”Ÿç†éœ€æ±‚ä¼¼ä¹éƒ½æ»¿è¶³äº†ã€‚\nå»ºè­°ï¼šå¯¶å¯¶å¯èƒ½è¦ºå¾—ç„¡èŠæˆ–æƒ³è¦æŠ±æŠ±ï¼ˆå°‹æ±‚ä¾é™„ï¼‰ã€‚\nè©¦è‘—æŠŠä»–æ›å€‹å§¿å‹¢ï¼Œæˆ–æ˜¯è·Ÿä»–èªªè©±äº’å‹•ï¼ˆå¦‚å½±ç‰‡ä¸­çš„å˜»å˜»è²ï¼‰ã€‚"

    print(f"åˆ†æçµæœ: {predicted_type}")
    print(f"å»ºè­°è¡Œå‹•:\n{final_advice}")
    print("########################################")

# --- ä¸»ç¨‹å¼åŸ·è¡Œ ---
if __name__ == "__main__":
    # è¨­å®šç›®æ¨™æª”æ¡ˆåç¨±
    target_file = 'baby_cry.wav'
    
    # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    if os.path.exists(target_file):
        result, level = analyze_cry_logic(target_file)
        
        if result:
            get_context_and_decide(result)
    else:
        print(f"âŒ éŒ¯èª¤ï¼šåœ¨æ¡Œé¢ä¸Šæ‰¾ä¸åˆ°æª”æ¡ˆ '{target_file}'")
        print("--------------------------------------------------")
        print("è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿä¿®æ­£ï¼š")
        print("1. è«‹å°‡æ‚¨çš„å½±ç‰‡ (.mov) è½‰æª”ç‚º .wav æ ¼å¼ã€‚")
        print(f"2. å°‡è½‰æª”å¾Œçš„æª”æ¡ˆé‡æ–°å‘½åç‚ºï¼š{target_file}")
        print("3. ç¢ºä¿è©²æª”æ¡ˆèˆ‡æ­¤ç¨‹å¼ç¢¼æ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾(æ¡Œé¢)ä¸­ã€‚")